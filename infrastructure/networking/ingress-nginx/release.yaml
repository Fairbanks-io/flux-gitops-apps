---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: ingress-nginx
  namespace: kube-system
spec:
  chart:
    spec:
      chart: ingress-nginx
      sourceRef:
        kind: HelmRepository
        name: kubernetes
        namespace: flux-system
  interval: 1h
  targetNamespace: kube-system
  values:
    rbac:
      create: true
    controller:
      autoscaling:
        enabled: true
        minReplicas: 2
        maxReplicas: 3
        targetCPUUtilizationPercentage: 50
      limits:
        cpu: 200m
      requests:
        cpu: 50m
        memory: 200Mi
      service:
        name: ingress-nginx-controller
        annotations:
          service.beta.kubernetes.io/do-loadbalancer-enable-proxy-protocol: true
      publishService:
        enabled: true
      config:
        stream-snippet: |
          upstream factorio-udp {
            server factorio.factorio.svc.cluster.local:30000;
          }

          server {
            listen 20000 udp;
            proxy_responses 0;
            proxy_bind $remote_addr transparent;
            proxy_pass factorio-udp;
          }
        annotation-value-word-blocklist: "load_module,root,serviceaccount"
        use-proxy-protocol: "true"
        proxy-body-size: 250m
        client-max-body-size: 250m
        proxy-connect-timeout: "60"
        proxy-read-timeout: "60"
      affinity:
      # An example of required pod anti-affinity
      topologySpreadConstraints:
      - labelSelector:
          matchLabels:
            app.kubernetes.io/instance: kube-system-ingress-nginx
        maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway